<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Cross-Border Shopping Assistant</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    #bgVideo {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -1;
      object-fit: cover;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
    }

    header {
      margin-top: 30px;
      font-size: 2em;
      font-weight: bold;
    }

    .lang-switch {
      position: absolute;
      top: 20px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
    }

    .lang-switch button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    .search-wrapper {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .search-wrapper input[type="text"] {
      padding: 18px;
      font-size: 18px;
      width: 540px;
      border-radius: 6px;
    }

    .search-wrapper button {
      padding: 18px 28px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
    }

    .main-row {
      margin-top: 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }

    #searchResults {
      width: 60%;
      min-width: 480px;
      max-height: 60vh;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 16px;
      border-radius: 8px;
      overflow-y: auto;
      font-size: 15px;
      line-height: 1.5;
      order: 2;
      text-align: left;
      position: relative;
    }

    /* 初始文本居中 */
    #searchResults.initial-state {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    /* Markdown样式 */
    #searchResults table {
      border-collapse: collapse;
      margin: 15px 0;
      background: rgba(255, 255, 255, 0.05);
      width: 100%;
    }

    #searchResults th, #searchResults td {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px;
      text-align: left;
    }

    #searchResults th {
      background: rgba(255, 255, 255, 0.1);
      font-weight: bold;
      color: inherit;
    }

    #searchResults strong {
      color: inherit;
      text-shadow: none;
    }

    #searchResults h1, #searchResults h2, #searchResults h3 {
      color: inherit;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    #searchResults ul, #searchResults ol {
      margin-left: 20px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    #searchResults li {
      margin-bottom: 5px;
    }

    #searchResults p {
      margin: 10px 0;
    }

    #keywordBox {
      width: 20%;
      min-width: 200px;
      max-height: 60vh;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 16px;
      border-radius: 8px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 15px;
      line-height: 1.5;
      order: 0;
    }

    .spacer {
      width: 10%;
      order: 1;
    }

    #keywordBox button.brand-button {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid white;
      margin: 6px 4px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: inline-block;
    }

    #keywordBox button.brand-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    #keywordStatus {
      font-style: italic;
      margin-bottom: 10px;
      color: #ccc;
    }

    #keywordBox .product-series-section {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
    }

    #keywordBox .section-title {
      color: #ccc;
      font-size: 12px;
      margin-bottom: 8px;
      font-style: italic;
    }

    .purchase-links-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px solid rgba(255, 255, 255, 0.5);
    }

    .purchase-links-title {
      color: white;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      text-align: left;
    }

    .purchase-links-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 400px;
    }

    .purchase-link-button {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid white;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: background-color 0.3s;
      text-align: center;
      display: block;
    }

    .purchase-link-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    /* 滚动文字栏样式 */
    .scrolling-text-container {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 900px;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 6px;
      padding: 12px 20px;
      overflow: hidden;
    }

    .scrolling-text {
      color: white;
      font-size: 16px;
      text-align: center;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .scrolling-text.active {
      opacity: 1;
    }

    /* 左下角按钮样式 */
    .bottom-left-buttons {
      position: fixed;
      bottom: 30px;
      left: 30px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }

    .bottom-left-buttons button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .bottom-left-buttons button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    /* 模态框遮罩层 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .modal-overlay.active {
      display: flex;
    }

    /* 帮助内容框 */
    .help-modal {
      background-color: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .help-modal h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
    }

    /* 名片图片框 */
    .card-modal {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }

    .card-modal img {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }

    /* 关闭按钮 */
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s;
    }

    .modal-close:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>
  <video autoplay muted loop id="bgVideo">
    <source src="/video/websiteBackgroundVideo1.mp4" type="video/mp4">
  </video>

  <div class="lang-switch">
    <button onclick="switchLang('zh')">中文</button>
    <button onclick="switchLang('en')">English</button>
    <button onclick="switchLang('ru')">Русский</button>
  </div>

  <header id="pageTitle">跨境购物助手</header>

  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="输入您想搜索的商品...">
    <button id="searchButton" onclick="performSearch()">搜索</button>
  </div>

  <div class="main-row">
    <div id="keywordBox">
      <div id="keywordStatus">这里会显示一些关键词</div>
    </div>
    <div class="spacer"></div>
    <div id="searchResults" class="initial-state">这里将显示搜索结果</div>
  </div>

  <!-- 滚动文字栏 -->
  <div class="scrolling-text-container">
    <div id="scrollingText" class="scrolling-text active"></div>
  </div>

  <!-- 左下角按钮 -->
  <div class="bottom-left-buttons">
    <button id="helpButton" onclick="showHelp()">帮助</button>
    <button id="authorButton" onclick="showAuthorCard()">作者名片</button>
  </div>

  <!-- 帮助模态框 -->
  <div id="helpOverlay" class="modal-overlay" onclick="closeModal(event, 'helpOverlay')">
    <div class="help-modal" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal(event, 'helpOverlay')">×</button>
      <h2 id="helpTitle">使用帮助</h2>
      <div id="helpContent"></div>
    </div>
  </div>

  <!-- 作者名片模态框 -->
  <div id="cardOverlay" class="modal-overlay" onclick="closeModal(event, 'cardOverlay')">
    <div class="card-modal" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal(event, 'cardOverlay')">×</button>
      <img id="authorCardImage" src="" alt="Author Card">
    </div>
  </div>

  <script>
    // 直接定义 CONFIG，不依赖外部文件
    const CONFIG = {
      API_KEY: "gsk-2025-secure-key-change-this",
      API_BASE_URL: "https://api.guishkakrasiviy.com"
    };

    // 支持通过 URL 参数动态指定 API 地址
    const urlParams = new URLSearchParams(window.location.search);
    const API_BASE_URL = urlParams.get('api') || CONFIG.API_BASE_URL;

    // 如果使用了自定义 API，在控制台显示
    if (urlParams.get('api')) {
      console.log('Using custom API:', API_BASE_URL);
    }

    // API认证密钥
    const API_KEY = typeof CONFIG !== 'undefined'
      ? CONFIG.API_KEY
      : "gsk-2025-secure-key-change-this";

    // 创建带认证的请求头
    function getAuthHeaders() {
      return {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${API_KEY}`
      };
    }

    const translations = {
      zh: {
        title: "跨境购物助手",
        placeholder: "输入您想搜索的商品...",
        button: "搜索",
        noInput: "请输入搜索内容。",
        keywordPlaceholder: "这里会显示一些关键词",
        resultPlaceholder: "这里将显示搜索结果",
        keywordInstruction: "请点击您感兴趣的词条",
        searching: "正在搜索，请稍候...",
        brandSearching: "请稍后，正在为您搜索",
        seriesLoading: "正在加载产品系列详情",
        purchaseTitle: "🛒 俄罗斯及国际电商平台购买链接：",
        brandLoadError: "品牌详情加载失败：",
        seriesLoadError: "产品系列详情加载失败：",
        brandDetailPrefix: "品牌详情：",
        seriesDetailPrefix: "产品系列详情：",
        seriesSuffix: "系列：",
        helpButton: "帮助",
        authorButton: "作者名片"
      },
      en: {
        title: "Cross-border Shopping Assistant",
        placeholder: "Enter the product you want...",
        button: "Search",
        noInput: "Please enter a search term.",
        keywordPlaceholder: "Keywords will be displayed here",
        resultPlaceholder: "Search results will be displayed here",
        keywordInstruction: "Please click on the keyword you are interested in",
        searching: "Searching, please wait...",
        brandSearching: "Please wait, searching for you",
        seriesLoading: "Loading product series details",
        purchaseTitle: "🛒 Russian & International E-commerce Links:",
        brandLoadError: "Failed to load brand details: ",
        seriesLoadError: "Failed to load series details: ",
        brandDetailPrefix: "Brand Details:",
        seriesDetailPrefix: "Series Details:",
        seriesSuffix: "Series:",
        helpButton: "Help",
        authorButton: "Author Card"
      },
      ru: {
        title: "Ассистент трансграничных покупок",
        placeholder: "Введите товар, который хотите купить...",
        button: "Поиск",
        noInput: "Пожалуйста, введите запрос.",
        keywordPlaceholder: "Здесь будут показаны ключевые слова",
        resultPlaceholder: "Здесь будут показаны результаты поиска",
        keywordInstruction: "Пожалуйста, нажмите на интересующее вас слово",
        searching: "Идет поиск, пожалуйста, подождите...",
        brandSearching: "Пожалуйста, подождите, ищем для вас",
        seriesLoading: "Загрузка деталей серии продуктов",
        purchaseTitle: "🛒 Ссылки на торговые площадки:",
        brandLoadError: "Не удалось загрузить информацию о бренде: ",
        seriesLoadError: "Не удалось загрузить информацию о серии: ",
        brandDetailPrefix: "Информация о бренде:",
        seriesDetailPrefix: "Информация о серии:",
        seriesSuffix: "Серия:",
        helpButton: "Помощь",
        authorButton: "Визитка автора"
      }
    };

    let currentLang = "zh";
    let currentSearchQuery = "";
    let scrollingTexts = {};
    let currentTextIndex = 0;
    let helpContent = {};

    // 加载帮助内容
    async function loadHelpContent() {
      try {
        const response = await fetch('/help_content.json');
        helpContent = await response.json();
      } catch (error) {
        console.error('Failed to load help content:', error);
        helpContent = {
          zh: { title: "使用帮助", content: "帮助内容加载失败" },
          en: { title: "Help", content: "Failed to load help content" },
          ru: { title: "Помощь", content: "Не удалось загрузить справку" }
        };
      }
    }

    // 显示帮助
    function showHelp() {
      const content = helpContent[currentLang] || helpContent['zh'];
      document.getElementById('helpTitle').textContent = content.title;
      document.getElementById('helpContent').textContent = content.content;
      document.getElementById('helpOverlay').classList.add('active');
    }

    // 显示作者名片
    function showAuthorCard() {
      const cardImage = document.getElementById('authorCardImage');
      const imagePath = `/images/author_card_${currentLang}.jpg`;
      cardImage.src = imagePath;
      cardImage.onerror = function() {
        this.src = '/images/author_card_default.jpg';
      };
      document.getElementById('cardOverlay').classList.add('active');
    }

    // 关闭模态框
    function closeModal(event, modalId) {
      event.stopPropagation();
      document.getElementById(modalId).classList.remove('active');
    }

    // 加载滚动文本
    async function loadScrollingTexts() {
      try {
        const response = await fetch('/scrolling_texts.json');
        scrollingTexts = await response.json();
        startScrollingText();
      } catch (error) {
        console.error('Failed to load scrolling texts:', error);
        scrollingTexts = {
          zh: ["欢迎使用跨境购物助手"],
          en: ["Welcome to Cross-border Shopping Assistant"],
          ru: ["Добро пожаловать в помощник трансграничных покупок"]
        };
        startScrollingText();
      }
    }

    // 开始滚动文本
    function startScrollingText() {
      updateScrollingText();
      setInterval(updateScrollingText, 5000);
    }

    // 更新滚动文本
    function updateScrollingText() {
      const texts = scrollingTexts[currentLang] || scrollingTexts['zh'];
      const scrollingElement = document.getElementById('scrollingText');

      scrollingElement.classList.remove('active');

      setTimeout(() => {
        let newIndex;
        do {
          newIndex = Math.floor(Math.random() * texts.length);
        } while (newIndex === currentTextIndex && texts.length > 1);

        currentTextIndex = newIndex;
        scrollingElement.textContent = texts[currentTextIndex];
        scrollingElement.classList.add('active');
      }, 500);
    }

    function switchLang(lang) {
      currentLang = lang;
      const t = translations[lang];

      document.getElementById("pageTitle").innerText = t.title;
      document.getElementById("searchInput").placeholder = t.placeholder;
      document.getElementById("searchButton").innerText = t.button;

      const keywordStatus = document.getElementById("keywordStatus");
      const searchResults = document.getElementById("searchResults");

      if (keywordStatus.innerText === translations.zh.keywordPlaceholder ||
          keywordStatus.innerText === translations.en.keywordPlaceholder ||
          keywordStatus.innerText === translations.ru.keywordPlaceholder) {
        keywordStatus.innerText = t.keywordPlaceholder;
      }

      if (searchResults.innerText === translations.zh.resultPlaceholder ||
          searchResults.innerText === translations.en.resultPlaceholder ||
          searchResults.innerText === translations.ru.resultPlaceholder) {
        searchResults.innerText = t.resultPlaceholder;
      }

      updateScrollingText();

      document.getElementById('helpButton').textContent = t.helpButton;
      document.getElementById('authorButton').textContent = t.authorButton;
    }

    async function performSearch() {
      const input = document.getElementById("searchInput").value;
      const results = document.getElementById("searchResults");
      const keywordBox = document.getElementById("keywordBox");
      const keywordStatus = document.getElementById("keywordStatus");

      if (input.trim() === "") {
        results.innerText = translations[currentLang].noInput;
        return;
      }

      // 移除初始状态类
      results.classList.remove('initial-state');
      results.innerHTML = "";
      keywordBox.innerHTML = `<div id="keywordStatus">${translations[currentLang].searching}</div>`;

      currentSearchQuery = input;

      try {
        const response = await fetch(`${API_BASE_URL}/search-stream`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({
            query: input,
            language: currentLang
          })
        });

        if (!response.ok) throw new Error("服务器响应错误！");

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                if (data.content) {
                  fullContent += data.content;
                  // 使用marked解析并显示
                  results.innerHTML = marked.parse(fullContent);
                }
                if (data.done) {
                  parseAndDisplayBrands(fullContent, keywordBox);
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            }
          }
        }
      } catch (err) {
        console.error('Search error:', err);
        results.innerText = translations[currentLang].noInput + ": " + err.message;
      }
    }

    function parseAndDisplayBrands(content, keywordBox) {
      const lines = content.split("\n");

      const brandLines = lines.filter(line => {
        const trimmed = line.trim();
        return trimmed.startsWith("👉 ") || trimmed.startsWith("👉");
      });

      const brands = brandLines.map(line => {
        return line.trim().replace(/^👉\s*/, "").trim();
      });

      const keywordStatus = document.getElementById("keywordStatus");
      keywordStatus.innerText = brands.length > 0 ? translations[currentLang].keywordInstruction : translations[currentLang].keywordPlaceholder;

      brands.forEach(brand => {
        const btn = document.createElement("button");
        btn.innerText = brand;
        btn.classList.add("brand-button");
        btn.onclick = async () => {
          document.getElementById("keywordStatus").innerText = translations[currentLang].brandSearching;
          try {
            const apiUrl = currentSearchQuery
              ? `${API_BASE_URL}/brand-detail-with-context-stream`
              : `${API_BASE_URL}/brand-detail-stream`;

            const requestBody = currentSearchQuery
              ? { brand: brand, context: currentSearchQuery, language: currentLang }
              : { brand: brand, language: currentLang };

            const res = await fetch(apiUrl, {
              method: "POST",
              headers: getAuthHeaders(),
              body: JSON.stringify(requestBody)
            });

            if (!res.ok) throw new Error("服务器错误！");

            // 创建品牌内容容器
            const brandContainer = document.createElement('div');
            brandContainer.style.marginTop = '20px';
            document.getElementById("searchResults").appendChild(brandContainer); // 先添加到DOM

            // 流式读取响应
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullContent = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  try {
                    const data = JSON.parse(line.slice(6));
                    if (data.content) {
                      fullContent += data.content;
                      // 使用marked解析并显示 - 实时更新
                      brandContainer.innerHTML = marked.parse(`## 📌 ${brand} ${translations[currentLang].brandDetailPrefix}\n\n${fullContent}`);
                    }
                    if (data.done) {
                      // 流式输出完成，解析产品系列（使用原始文本）
                      parseBrandSeries(fullContent, brand);
                    }
                  } catch (e) {
                    console.error('Parse error:', e);
                  }
                }
              }
            }

            document.getElementById("keywordStatus").innerText = translations[currentLang].keywordInstruction;
          } catch (err) {
            alert(translations[currentLang].brandLoadError + err.message);
            document.getElementById("keywordStatus").innerText = translations[currentLang].keywordInstruction;
          }
        };
        keywordBox.appendChild(btn);
      });
    }

    // 解析品牌内容中的产品系列
    function parseBrandSeries(content, brand) {
      const productLines = content.split("\n");
      const series = [];

      productLines.forEach(line => {
        const trimmedLine = line.trim();

        if (trimmedLine.startsWith("◆◆◆ ")) {
          let seriesName = trimmedLine.replace("◆◆◆ ", "").trim();
          seriesName = seriesName.replace(/\*+([^*]+)\*+/g, '$1');

          const nameWithDescMatch = seriesName.match(/^"?([^"(]+)"?\s*\(/);
          if (nameWithDescMatch) {
            seriesName = nameWithDescMatch[1].trim();
          } else {
            const englishMatch = seriesName.match(/[（(]([A-Za-z\s\-]+)[）)]/);
            if (currentLang !== "zh" && englishMatch) {
              seriesName = englishMatch[1].trim();
            } else if (currentLang !== "zh") {
              const pureEnglishMatch = seriesName.match(/([A-Za-z\s\-]+)/);
              if (pureEnglishMatch) {
                seriesName = pureEnglishMatch[1].trim();
              }
            }
          }
          series.push(seriesName);
        }
        else if (trimmedLine.startsWith("🔸 ")) {
          let seriesName = trimmedLine.replace("🔸 ", "").trim();
          seriesName = seriesName.replace(/\*+([^*]+)\*+/g, '$1');

          const nameWithDescMatch = seriesName.match(/^"?([^"(]+)"?\s*\(/);
          if (nameWithDescMatch) {
            seriesName = nameWithDescMatch[1].trim();
          } else {
            const englishMatch = seriesName.match(/[（(]([A-Za-z\s\-]+)[）)]/);
            if (currentLang !== "zh" && englishMatch) {
              seriesName = englishMatch[1].trim();
            } else if (currentLang !== "zh") {
              const pureEnglishMatch = seriesName.match(/([A-Za-z\s\-]+)/);
              if (pureEnglishMatch) {
                seriesName = pureEnglishMatch[1].trim();
              }
            }
          }
          series.push(seriesName);
        }
      });

      if (series.length > 0) {
        const keywordBox = document.getElementById("keywordBox");
        const seriesSection = document.createElement("div");
        seriesSection.classList.add("product-series-section");

        const sectionTitle = document.createElement("div");
        sectionTitle.classList.add("section-title");
        sectionTitle.innerText = currentSearchQuery
          ? `${brand} ${currentSearchQuery}${translations[currentLang].seriesSuffix}`
          : `${brand} ${translations[currentLang].seriesSuffix}`;
        seriesSection.appendChild(sectionTitle);

        series.forEach(seriesName => {
          const seriesBtn = document.createElement("button");
          seriesBtn.innerText = seriesName;
          seriesBtn.classList.add("brand-button");
          seriesBtn.onclick = async () => {
            document.getElementById("keywordStatus").innerText = translations[currentLang].seriesLoading;
            try {
              const apiUrl = currentSearchQuery
                ? `${API_BASE_URL}/product-detail-with-context-stream`
                : `${API_BASE_URL}/product-detail-stream`;

              const requestBody = currentSearchQuery
                ? { brand: `${brand} ${seriesName}`, context: currentSearchQuery, language: currentLang }
                : { brand: `${brand} ${seriesName}`, language: currentLang };

              const seriesRes = await fetch(apiUrl, {
                method: "POST",
                headers: getAuthHeaders(),
                body: JSON.stringify(requestBody)
              });

              if (!seriesRes.ok) throw new Error("服务器错误！");

              // 创建产品系列内容容器
              const seriesContainer = document.createElement('div');
              seriesContainer.style.marginTop = '20px';
              document.getElementById("searchResults").appendChild(seriesContainer); // 先添加到DOM

              // 立即开始生成购买链接（不等待内容加载完成）
              generatePurchaseLinks(brand, seriesName);

              // 流式读取响应
              const reader = seriesRes.body.getReader();
              const decoder = new TextDecoder();
              let buffer = '';
              let seriesFullContent = '';

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                  if (line.startsWith('data: ')) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      if (data.content) {
                        seriesFullContent += data.content;
                        // 使用marked解析并显示 - 实时更新
                        seriesContainer.innerHTML = marked.parse(`## 🔹 ${seriesName} ${translations[currentLang].seriesDetailPrefix}\n\n${seriesFullContent}`);
                      }
                    } catch (e) {
                      console.error('Parse error:', e);
                    }
                  }
                }
              }

              document.getElementById("keywordStatus").innerText = translations[currentLang].keywordInstruction;
            } catch (err) {
              alert(translations[currentLang].seriesLoadError + err.message);
              document.getElementById("keywordStatus").innerText = translations[currentLang].keywordInstruction;
            }
          };
          seriesSection.appendChild(seriesBtn);
        });

        keywordBox.appendChild(seriesSection);
      }
    }

    // 生成购买链接
    async function generatePurchaseLinks(brand, seriesName) {
      try {
        let searchKeyword = `${brand} ${seriesName}`;
        
        // 对于中文，先获取英文关键词
        if (currentLang === 'zh') {
          try {
            const keywordRes = await fetch(`${API_BASE_URL}/generate-keyword`, {
              method: "POST",
              headers: getAuthHeaders(),
              body: JSON.stringify({
                brand: brand,
                series: seriesName,
                category: currentSearchQuery,
                language: currentLang
              })
            });
            
            if (keywordRes.ok) {
              const keywordData = await keywordRes.json();
              searchKeyword = keywordData.keyword;
            }
          } catch (err) {
            console.error('Keyword generation failed:', err);
          }
        }
        
        // 生成购买链接
        const purchaseLinksHtml = `
          <div class="purchase-links-section">
            <div class="purchase-links-title">${translations[currentLang].purchaseTitle}</div>
            <div class="purchase-links-grid">
              <a href="https://www.ozon.ru/search/?text=${encodeURIComponent(searchKeyword)}"
                 target="_blank" class="purchase-link-button">
                Ozon.ru
              </a>
              <a href="https://www.wildberries.ru/catalog/0/search.aspx?search=${encodeURIComponent(searchKeyword)}"
                 target="_blank" class="purchase-link-button">
                Wildberries
              </a>
              <a href="https://market.yandex.ru/search?text=${encodeURIComponent(searchKeyword)}"
                 target="_blank" class="purchase-link-button">
                Yandex.Market
              </a>
              <a href="https://www.alibaba.com/trade/search?SearchText=${encodeURIComponent(searchKeyword)}"
                 target="_blank" class="purchase-link-button">
                Alibaba
              </a>
            </div>
          </div>
        `;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = purchaseLinksHtml;
        document.getElementById("searchResults").appendChild(tempDiv.firstElementChild);

        // 对于非中文语言，异步更新关键词（如果需要优化）
        if (currentLang !== 'zh') {
          fetch(`${API_BASE_URL}/generate-keyword`, {
            method: "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify({
              brand: brand,
              series: seriesName,
              category: currentSearchQuery,
              language: currentLang
            })
          }).then(keywordRes => {
            if (keywordRes.ok) {
              return keywordRes.json();
            }
          }).then(keywordData => {
            if (keywordData && keywordData.keyword) {
              searchKeyword = keywordData.keyword;
              
              // 更新所有购买链接
              const purchaseSection = document.querySelector('.purchase-links-section:last-child');
              if (purchaseSection) {
                const links = purchaseSection.querySelectorAll('.purchase-link-button');
                links[0].href = `https://www.ozon.ru/search/?text=${encodeURIComponent(searchKeyword)}`;
                links[1].href = `https://www.wildberries.ru/catalog/0/search.aspx?search=${encodeURIComponent(searchKeyword)}`;
                links[2].href = `https://market.yandex.ru/search?text=${encodeURIComponent(searchKeyword)}`;
                links[3].href = `https://www.alibaba.com/trade/search?SearchText=${encodeURIComponent(searchKeyword)}`;
              }
            }
          }).catch(err => {
            console.error('Keyword optimization failed:', err);
          });
        }
      } catch (err) {
        console.error('Error generating purchase links:', err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("searchInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          performSearch();
        }
      });
      switchLang(currentLang);

      document.getElementById("keywordStatus").innerText = translations[currentLang].keywordPlaceholder;
      document.getElementById("searchResults").innerText = translations[currentLang].resultPlaceholder;

      loadScrollingTexts();
      loadHelpContent();
    });
  </script>
</body>

</html>
